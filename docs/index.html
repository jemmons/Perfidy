<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Perfidy  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Perfidy  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">Perfidy Docs</a> (27% documented)</p>
        <p class="header-right"><a href="https://github.com/jemmons/Perfidy"><img src="img/gh.png"/>View on GitHub</a></p>
        <p class="header-right"><a href="dash-feed://https%3A%2F%2Fjemmons%2Egithub%2Eio%2FPerfidy%2Fdocsets%2FPerfidy%2Exml"><img src="img/dash.png"/>Install in Dash</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">Perfidy Reference</a>
        <img id="carat" src="img/carat.png" />
        Perfidy  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/FakeServer.html">FakeServer</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FakeServer.html#/s:VC7Perfidy10FakeServer19FakeServerCallbacks">– FakeServerCallbacks</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/Verb.html">Verb</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Functions.html#/s:F7Perfidyoi2eeFTVS_5RouteS0__Sb">==(_:_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/Response.html">Response</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Route.html">Route</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <a href='#perfidy' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='perfidy'>Perfidy</h1>
<a href='#fake-service-for-ios-testing' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='fake-service-for-ios-testing'>Fake service for iOS testing.</h4>

<p><a href="https://github.com/Carthage/Carthage"><img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible"></a></p>

<p>Perfidy is tiny HTTP server written in Swift. We can spin it up in our tests to fake out our API without hitting the network. This keeps our tests isolated and fast.</p>
<a href='#introduction' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='introduction'>Introduction</h2>

<p>The syntax is, at least initially, pretty straight forward:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Perfidy</span>

<span class="k">let</span> <span class="nv">server</span> <span class="o">=</span> <span class="kt">FakeServer</span><span class="p">()</span>
<span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"/path/to/hit"</span><span class="p">)</span>
<span class="k">try!</span> <span class="n">server</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
<span class="c1">// Do things that connect to http://localhost:10175/path/to/hit</span>
<span class="n">server</span><span class="o">.</span><span class="nf">stop</span><span class="p">()</span>
</code></pre>

<p>Of course, outside of a test, this doesn&rsquo;t do much for us. Here&rsquo;s what it looks like in an XCTest:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">XCTest</span>
<span class="kd">import</span> <span class="kt">Perfidy</span>
<span class="kd">import</span> <span class="kt">MyApp</span>

<span class="kd">class</span> <span class="kt">MyTests</span> <span class="p">:</span> <span class="kt">XCTestCase</span><span class="p">{</span>
  <span class="k">var</span> <span class="nv">server</span> <span class="o">=</span> <span class="kt">FakeServer</span><span class="p">()</span>
  <span class="k">override</span> <span class="kd">func</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span> <span class="k">try!</span> <span class="n">server</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">}</span>
  <span class="k">override</span> <span class="kd">func</span> <span class="nf">tearDown</span><span class="p">()</span> <span class="p">{</span> <span class="n">server</span><span class="o">.</span><span class="nf">stop</span><span class="p">()</span> <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">testMyThings</span><span class="p">(){</span>
    <span class="k">let</span> <span class="nv">shouldRespond</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"responded"</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"/path/to/hit"</span><span class="p">)</span>
    <span class="n">myApp</span><span class="o">.</span><span class="nf">doThingThatHitsTheNetwork</span><span class="p">()</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
      <span class="n">shouldRespond</span><span class="o">.</span><span class="nf">fulfill</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>There&rsquo;s a very common pattern here: create a <code>FakeServer</code> object, fake out some endpoints, start it up, run some code, and shut it down. In fact, it&rsquo;s so common, Perfidy offers some conveniences for it:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">testMyThings</span><span class="p">(){</span>
  <span class="k">let</span> <span class="nv">shouldRespond</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"responded"</span><span class="p">)</span>

  <span class="kt">FakeServer</span><span class="o">.</span><span class="n">runWith</span> <span class="p">{</span> <span class="n">server</span> <span class="k">in</span>
    <span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"/path/to/hit"</span><span class="p">)</span>
    <span class="n">myApp</span><span class="o">.</span><span class="nf">doThingThatHitsTheNetwork</span><span class="p">()</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
      <span class="n">shouldRespond</span><span class="o">.</span><span class="nf">fulfill</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>This encapsulates the creation, running, and halting of the fake server, elimitating the need for <code>setUp</code> and <code>tearDown</code> methods in most common cases.</p>
<a href='#faking-endpoints' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='faking-endpoints'>Faking Endpoints</h2>

<p>There are two reasons we might want to fake out an endpoint for our tests:</p>

<ul>
<li>We want to validate a request our app is sending to a server.</li>
<li>We want to test an aspect of our app that depends on getting data from a server.</li>
</ul>
<a href='#validate-requests' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='validate-requests'>Validate Requests</h3>

<p>Endpoints can be added with a handler that gets called when a request is received. It can be used to validate the contents of the given request:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">testPostedData</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">postedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="n">dataFromMyApp</span>
  <span class="k">let</span> <span class="nv">shouldSend</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"Sent data"</span><span class="p">)</span>

  <span class="kt">FakeServer</span><span class="o">.</span><span class="n">runWith</span> <span class="p">{</span> <span class="n">server</span> <span class="k">in</span>
    <span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"POST /foo"</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span> <span class="k">in</span>
      <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">httpBody</span><span class="p">,</span> <span class="n">dataFromMyApp</span><span class="p">)</span>
      <span class="n">shouldSend</span><span class="o">.</span><span class="nf">fulfill</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">myApp</span><span class="o">.</span><span class="nf">postData</span><span class="p">(</span><span class="n">dataFromMyApp</span><span class="p">)</span>

    <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<a href='#fake-responses' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='fake-responses'>Fake Responses</h3>

<p>Sometimes our app needs to get back specific data or errors from a server in order to exercise a code path. We can add endpoints that respond with arbitrary status codes, headers, strings, json, or even plain ol&rsquo; bytes:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">testGetListings</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">shouldFetch</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"Received data"</span><span class="p">)</span>

  <span class="kt">FakeServer</span><span class="o">.</span><span class="n">runWith</span> <span class="p">{</span> <span class="n">server</span> <span class="k">in</span>
    <span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"/listings"</span><span class="p">,</span> <span class="nv">response</span><span class="p">:</span> <span class="n">fakeListingsJSON</span><span class="p">)</span>
    <span class="n">myApp</span><span class="o">.</span><span class="n">loadListingsView</span> <span class="p">{</span>
      <span class="c1">// Assert listing details here...</span>
      <span class="n">shouldFetch</span><span class="o">.</span><span class="nf">fulfill</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Often a single unit of functionality will make many API calls in the course of running. Adding an array of responses is easy:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">endpoints</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="s">"/listing"</span><span class="p">,</span> <span class="n">listingJSON</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"/image"</span><span class="p">,</span>   <span class="n">imageData</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"/reviews"</span><span class="p">,</span> <span class="n">reviewJSON</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">endpoints</span><span class="p">)</span>
</code></pre>
<a href='#and-much-more' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='and-much-more'>…And Much More!</h3>

<p><code>add()</code> has a lot of flexibility in its syntax. These are all valid expressions, for example:</p>
<pre class="highlight swift"><code><span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"POST /foo"</span><span class="p">,</span> <span class="nv">response</span><span class="p">:</span> <span class="mi">201</span><span class="p">)</span> 
<span class="n">server</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="kt">Route</span><span class="p">(</span><span class="nv">method</span><span class="p">:</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span> <span class="nv">path</span><span class="p">:</span><span class="s">"/foo"</span><span class="p">),</span> <span class="nv">response</span><span class="p">:</span> <span class="p">[</span><span class="s">"data"</span><span class="p">:</span> <span class="s">"hello"</span><span class="p">])</span>
</code></pre>

<p>See the documentation for <code>Route</code> and <code>Response</code> for more examples.</p>
<a href='#attribution' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='attribution'>Attribution</h2>

<p>Perfidy makes use of networking code from the amazing <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket project</a>. I used to write C socket libraries in the 90s. I can&rsquo;t tell you how happy I am not to have to do it again.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2017 <a class="link" href="https://figure.ink" target="_blank" rel="external">Joshua Emmons</a>. All rights reserved. (Last updated: 2017-02-23)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.3</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
